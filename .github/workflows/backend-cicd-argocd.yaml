name: Backend CI/CD with ArgoCD

on:
  push:
    branches: [main, develop]
    paths:
      - 'api-gateway/**'
      - 'user-service/**'
      - 'bill-service/**'
      - 'product-service/**'
      - 'kos-mock/**'
      - 'common/**'
      - 'build.gradle'
      - 'settings.gradle'
  pull_request:
    branches: [main, develop]
    paths:
      - 'api-gateway/**'
      - 'user-service/**'
      - 'bill-service/**'
      - 'product-service/**'
      - 'kos-mock/**'
      - 'common/**'
      - 'build.gradle'
      - 'settings.gradle'

env:
  ACR_NAME: acrdigitalgarage01
  RESOURCE_GROUP: rg-digitalgarage-01
  AKS_CLUSTER: aks-digitalgarage-01
  SYSTEM_NAME: phonebill
  MANIFEST_REPO_URL: https://github.com/hyeda2020/phonebill.git

jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
      environment: ${{ steps.set-env.outputs.environment }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set environment based on branch
      id: set-env
      run: |
        if [[ ${{ github.ref }} == 'refs/heads/main' ]]; then
          echo "environment=prod" >> $GITHUB_OUTPUT
        elif [[ ${{ github.ref }} == 'refs/heads/develop' ]]; then
          echo "environment=dev" >> $GITHUB_OUTPUT
        else
          echo "environment=dev" >> $GITHUB_OUTPUT
        fi

    - name: Set image tag
      id: set-tag
      run: |
        echo "image_tag=${{ github.sha }}" >> $GITHUB_OUTPUT

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build with Gradle
      run: ./gradlew clean build -x test

    - name: Run tests
      run: ./gradlew test

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: |
          **/build/test-results/test/TEST-*.xml

  release:
    name: Build and Push Docker Images
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Set environment variables
      run: |
        echo "IMAGE_TAG=${{ needs.build.outputs.image_tag }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ needs.build.outputs.environment }}" >> $GITHUB_ENV

    - name: Azure Container Registry Login
      uses: azure/docker-login@v1
      with:
        login-server: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Build JAR files
      run: ./gradlew bootJar

    - name: Build and push Docker images
      run: |
        services="api-gateway user-service bill-service product-service kos-mock"

        for service in $services; do
          echo "Building Docker image for $service..."

          # Dockerfile ìƒì„±
          cat > $service/Dockerfile << EOF
        FROM openjdk:17-jre-slim

        WORKDIR /app

        COPY build/libs/*.jar app.jar

        EXPOSE 8080

        ENTRYPOINT ["java", "-jar", "app.jar"]
        EOF

          # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }} $service/
          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }}

          echo "âœ… $service image pushed successfully"
        done

  update-manifest:
    name: Update Manifest Repository
    needs: [build, release]
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
    - name: Set image tag environment variable
      run: |
        echo "IMAGE_TAG=${{ needs.build.outputs.image_tag }}" >> $GITHUB_ENV
        echo "ENVIRONMENT=${{ needs.build.outputs.environment }}" >> $GITHUB_ENV

    - name: Update Manifest Repository
      run: |
        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë ˆí¬ì§€í† ë¦¬ í´ë¡ 
        REPO_URL=$(echo "${{ env.MANIFEST_REPO_URL }}" | sed 's|https://||')
        git clone https://${{ secrets.GIT_USERNAME }}:${{ secrets.GIT_PASSWORD }}@${REPO_URL} manifest-repo
        cd manifest-repo

        # Kustomize ì„¤ì¹˜
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/

        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ í™•ì¸ ë° ìƒì„±
        if [ ! -d "${{ env.SYSTEM_NAME }}/kustomize/overlays/${{ env.ENVIRONMENT }}" ]; then
          echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë””ë ‰í† ë¦¬ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë ˆí¬ì§€í† ë¦¬ë¥¼ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”."
          exit 1
        fi

        # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        cd ${{ env.SYSTEM_NAME }}/kustomize/overlays/${{ env.ENVIRONMENT }}

        # ê° ì„œë¹„ìŠ¤ë³„ ì´ë¯¸ì§€ íƒœê·¸ ì—…ë°ì´íŠ¸
        services="api-gateway user-service bill-service product-service kos-mock"
        for service in $services; do
          echo "Updating $service image tag..."
          kustomize edit set image ${{ env.ACR_NAME }}.azurecr.io/${{ env.SYSTEM_NAME }}/$service:${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }}
        done

        # Git ì„¤ì • ë° í‘¸ì‹œ
        cd ../../../..
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "ğŸš€ Update ${{ env.SYSTEM_NAME }} ${{ env.ENVIRONMENT }} images to ${{ env.ENVIRONMENT }}-${{ env.IMAGE_TAG }}"
        git push origin main

        echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ. ArgoCDê°€ ìë™ìœ¼ë¡œ ë°°í¬í•©ë‹ˆë‹¤."

  notify:
    name: Notify Results
    needs: [build, release, update-manifest]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Notify Success
      if: needs.build.result == 'success' && needs.release.result == 'success' && needs.update-manifest.result == 'success'
      run: |
        echo "ğŸ‰ CI/CD íŒŒì´í”„ë¼ì¸ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
        echo "ğŸ“¦ ì´ë¯¸ì§€ íƒœê·¸: ${{ needs.build.outputs.environment }}-${{ needs.build.outputs.image_tag }}"
        echo "ğŸŒ í™˜ê²½: ${{ needs.build.outputs.environment }}"
        echo "ğŸš€ ArgoCDë¥¼ í†µí•´ ìë™ ë°°í¬ê°€ ì‹œì‘ë©ë‹ˆë‹¤."

    - name: Notify Failure
      if: needs.build.result == 'failure' || needs.release.result == 'failure' || needs.update-manifest.result == 'failure'
      run: |
        echo "âŒ CI/CD íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."
        echo "ë¹Œë“œ ê²°ê³¼: ${{ needs.build.result }}"
        echo "ë¦´ë¦¬ìŠ¤ ê²°ê³¼: ${{ needs.release.result }}"
        echo "ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ê²°ê³¼: ${{ needs.update-manifest.result }}"